# Drishtik â€” Home Assistant Unified Automation
# Trigger: MQTT topic openclaw/frigate/analysis
# Actions: Alexa TTS, Mobile push, Dashboard notification
#
# Import this into your HA automations.yaml or via Settings -> Automations

alias: "Drishtik AI Unified Automation"
description: "Handles all AI security alerts: Alexa, mobile push, dashboard"

triggers:
  - trigger: mqtt
    topic: openclaw/frigate/analysis

variables:
  camera: "{{ trigger.payload_json.camera }}"
  analysis: "{{ trigger.payload_json.analysis }}"
  risk: "{{ trigger.payload_json.risk | default('low') }}"
  tts: "{{ trigger.payload_json.tts | default('Security alert') }}"
  event_id: "{{ trigger.payload_json.event_id | default('') }}"
  snapshot_path: "{{ trigger.payload_json.snapshot_path | default('') }}"
  severity_emoji: >-
    {% if risk == 'critical' %}ðŸ”´
    {% elif risk == 'high' %}ðŸŸ 
    {% elif risk == 'medium' %}ðŸŸ¡
    {% else %}ðŸŸ¢{% endif %}

actions:
  # 1. Alexa TTS announcement (medium+ only, daytime 6AM-11PM)
  - if:
      - condition: template
        value_template: "{{ risk in ['medium', 'high', 'critical'] }}"
      - condition: time
        after: "06:00:00"
        before: "23:00:00"
    then:
      - action: notify.alexa_media
        data:
          title: "Security Alert"
          message: "{{ tts }}"
          data:
            type: announce
          target:
            # Replace with your Alexa device entity IDs
            - media_player.echo_device_1
            - media_player.echo_device_2

  # 2. Mobile push notification (always)
  - action: notify.notify
    data:
      title: "{{ severity_emoji }} {{ camera }} â€” {{ risk | upper }}"
      message: "{{ analysis }}"
      data:
        tag: "frigate-{{ camera }}"
        group: frigate-security
        importance: >-
          {% if risk == 'critical' %}max
          {% elif risk == 'high' %}high
          {% elif risk == 'medium' %}default
          {% else %}min{% endif %}
        image: "/media/frigate/ai-snapshots/{{ event_id }}.jpg"

  # 3. Persistent notification on HA dashboard
  - action: persistent_notification.create
    data:
      title: "{{ severity_emoji }} Security: {{ camera }}"
      message: "{{ analysis }}"
      notification_id: "frigate_{{ camera }}"

  # 4. Logbook entry
  - action: logbook.log
    data:
      name: "Drishtik"
      message: "{{ severity_emoji }} {{ camera }} â€” {{ risk | upper }}: {{ tts }}"
      entity_id: sensor.frigate_ai_analysis
